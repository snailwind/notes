### 游标练习题

#### 1. 用游标显示所有部门编号与名称，以及其所拥有的员工人数。

`--表连接`

```SQL
SELECT D.DEPTNO,D.DNAME,COUNT(EMPNO) CT
  FROM DEPT D
  LEFT JOIN EMP E 
  ON D.DEPTNO = E.DEPTNO
 GROUP BY D.DEPTNO,D.DNAME;

DECLARE
  CURSOR A IS
    SELECT D.DEPTNO,D.DNAME,COUNT(EMPNO) CT
      FROM DEPT D
      LEFT JOIN EMP E
        ON D.DEPTNO = E.DEPTNO
     GROUP BY D.DEPTNO,D.DNAME;
  B A%ROWTYPE;
BEGIN
  OPEN A;
  LOOP
    FETCH A INTO B;
    EXIT WHEN A%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(B.DEPTNO||' '||RPAD(B.DNAME,10)||' '||B.CT);
  END LOOP;
  CLOSE A;
END;
```



#### 2.用游标属性`%ROWCOUNT`实现输出前十个员工的信息。(表中前10名即可，没有特定顺序)

`--%ROWCOUNT是一个累计的结果`

```SQL
DECLARE
  CURSOR B IS
    SELECT * FROM EMP;
  BB B%ROWTYPE;
BEGIN
  OPEN B;
  LOOP
    FETCH B INTO BB;
    EXIT WHEN B%ROWCOUNT > 10;
    DBMS_OUTPUT.PUT_LINE(BB.EMPNO||' '||BB.ENAME||' '||BB.JOB||' '||
                         BB.MGR||' '||TO_CHAR(BB.HIREDATE,'YYYY/MM/DD')||' '||BB.SAL||' '||
                         BB.COMM||' '||BB.DEPTNO);
  END LOOP;
  CLOSE B;
END;
```



#### 3.通过使用游标来显示`DEPT`表中的部门名称，及其相应的员工列表（提示:可以使用双重循环）。

```SQL
格式举例:
ACCOUNTING
-----------
KING
MILLER
CLARK

RESEARCH
-----------
...
```

```SQL
--双游标+双循环
--外循环用于获取部门信息并将部门编号通过参数传递给内循环
--内循环接收到部门编号后获取相应员工信息
DECLARE 
  CURSOR C1 IS SELECT * FROM DEPT ORDER BY DEPTNO;
  CURSOR C2(V_D NUMBER) IS SELECT * FROM EMP WHERE DEPTNO = V_D;
  CC1 C1%ROWTYPE;
  CC2 C2%ROWTYPE;
BEGIN
  OPEN C1;
  LOOP
    FETCH C1 INTO CC1;
    EXIT WHEN C1%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(CC1.DNAME);
    DBMS_OUTPUT.PUT_LINE('------------');
    OPEN C2(CC1.DEPTNO);
    LOOP
      FETCH C2 INTO CC2;
      EXIT WHEN C2%NOTFOUND;
      DBMS_OUTPUT.PUT_LINE(CC2.ENAME);
    END LOOP;
    CLOSE C2;
    DBMS_OUTPUT.PUT_LINE ('           ');
  END LOOP;
  CLOSE C1;
END;
```



#### 4.接收一个部门号，使用`FOR循环`，从`EMP`表中显示该部门的所有雇员的姓名，工作和薪水。

```SQL
DECLARE
  CURSOR D IS SELECT ENAME,JOB,SAL FROM EMP WHERE DEPTNO = &给定一个部门;
BEGIN
  FOR DD IN D LOOP
    DBMS_OUTPUT.PUT_LINE(DD.ENAME||' '||DD.JOB||' '||DD.SAL);
  END LOOP;
END;
```



```SQL
DECLARE
  CURSOR D(V_DEPTNO NUMBER := &给定一个部门) IS SELECT ENAME, JOB, SAL FROM EMP WHERE DEPTNO = V_DEPTNO;
BEGIN
  FOR DD IN D LOOP
    DBMS_OUTPUT.PUT_LINE(DD.ENAME||' '||DD.JOB||' '||DD.SAL);
  END LOOP;
END;
```



```SQL
DECLARE
  CURSOR D(V_DEPTNO NUMBER) IS SELECT ENAME, JOB, SAL FROM EMP WHERE DEPTNO = V_DEPTNO;
BEGIN
  FOR DD IN D(&给定一个部门) LOOP
    DBMS_OUTPUT.PUT_LINE(DD.ENAME||' '||DD.JOB||' '||DD.SAL);
  END LOOP;
END;
```



#### 5.编写一个程序块，将`EMP`表中前5人的名字，及其处的工资等级(`SALGRADE`)显示出来。

`--表连接+%ROWCOUNT`

```SQL
SELECT * FROM EMP E JOIN SALGRADE S ON E.SAL BETWEEN S.LOSAL AND S.HISAL;

DECLARE
  CURSOR E IS SELECT * FROM EMP E JOIN SALGRADE S ON E.SAL BETWEEN S.LOSAL AND S.HISAL;
  EE E%ROWTYPE;
BEGIN
  OPEN E;
  LOOP
    FETCH E INTO EE;
    EXIT WHEN E%NOTFOUND OR E%ROWCOUNT > 5;
    DBMS_OUTPUT.PUT_LINE(EE.ENAME||' '||EE.GRADE);
  END LOOP;
  CLOSE E;
END;
```



#### 6.用带参数的游标输出部门编号为10和30的员工信息。

`--OPEN CUR_NAME (10);`

```SQL
DECLARE
  CURSOR F(I_DEPTNO NUMBER) IS SELECT * FROM EMP WHERE DEPTNO = I_DEPTNO;
  FF F%ROWTYPE;
BEGIN
  OPEN F(10);
  LOOP
    FETCH F INTO FF;
    EXIT WHEN F%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(FF.EMPNO||' '||FF.ENAME||' '||FF.JOB||' '||FF.MGR||' '||TO_CHAR(FF.HIREDATE, 'YYYY/MM/DD')||' '||FF.SAL||' '||NVL(FF.COMM, 0)||' '||FF.DEPTNO);
  END LOOP;
  CLOSE F;
  DBMS_OUTPUT.PUT_LINE('================================================='); 
  OPEN F(30);
  LOOP
    FETCH F INTO FF;
    EXIT WHEN F%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(FF.EMPNO||' '||FF.ENAME||' '||FF.JOB||' '||FF.MGR||' '||TO_CHAR(FF.HIREDATE, 'YYYY/MM/DD')||' '||FF.SAL||' '||NVL(FF.COMM, 0)||' '||FF.DEPTNO);
  END LOOP;
  CLOSE F;
END;
```



```SQL
--查询指定部门、指定岗位的员工信息
DECLARE
  CURSOR F(I_DEPTNO NUMBER,I_JOB VARCHAR2) IS SELECT * FROM EMP WHERE DEPTNO = I_DEPTNO AND JOB = I_JOB;
  FF F%ROWTYPE;
BEGIN
  OPEN F(10,'MANAGER');
  LOOP
    FETCH F INTO FF;
    EXIT WHEN F%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(FF.EMPNO||' '||FF.ENAME||' '||FF.JOB||' '||FF.MGR||' '||TO_CHAR(FF.HIREDATE, 'YYYY/MM/DD')||' '||FF.SAL||' '||NVL(FF.COMM, 0)||' '||FF.DEPTNO);
  END LOOP;
  CLOSE F;
END;
```



#### 7.使用带参数的游标，实现接收一个部门名称，从`EMP`表中显示该部门的所有雇员的姓名，工作和薪水。

```SQL
DECLARE
  V_DNAME VARCHAR2(10) := '&请输入部门名称';
  V_DEPTNO NUMBER;
  CURSOR G (I_DEPTNO NUMBER) IS SELECT ENAME,JOB,SAL FROM EMP WHERE DEPTNO = I_DEPTNO;
  GG G%ROWTYPE;
BEGIN
  SELECT DEPTNO INTO V_DEPTNO FROM DEPT WHERE DNAME = V_DNAME;
  OPEN G(V_DEPTNO);
  LOOP
    FETCH G INTO GG;
    EXIT WHEN G%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(GG.ENAME||' '||GG.JOB||' '||GG.SAL);
  END LOOP;
  CLOSE G;
END;
```



#### 8.用游标获取所有收入超过2000的销售人员信息.

`--SAL > 2000`

```SQL
SELECT * FROM EMP WHERE SAL + NVL(COMM,0) > 2000 AND JOB = 'SALESMAN';

DECLARE 
  CURSOR H IS SELECT * FROM EMP WHERE SAL + NVL(COMM,0) > 2000 AND JOB = 'SALESMAN';
  HH H%ROWTYPE;
BEGIN 
  OPEN H;
  LOOP 
    FETCH H INTO HH;
    EXIT WHEN H%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(HH.EMPNO||' '||HH.ENAME||' '||HH.JOB||' '||HH.MGR||' '||TO_CHAR(HH.HIREDATE, 'YYYY/MM/DD')||' '||HH.SAL||' '||NVL(HH.COMM, 0)||' '||HH.DEPTNO);
  END LOOP;
  CLOSE H;
END;
```



#### 9.按照`SALGRADE`表中的标准，给员工加薪，`1:5%`，`2:4%`，`3:3%`，`4:2%`，`5: 1%`，并打印输出每个人，加薪前后的工资。

`--1.游标循环过程中除了读取，可以做DML操作`
`--2.格式要求:SMITH加薪前的工资为800，加薪后的工资为840`

```SQL
DECLARE
  CURSOR I IS
    SELECT E.ENAME, E.SAL, S.GRADE
      FROM EMP E
      JOIN SALGRADE S
        ON E.SAL BETWEEN S.LOSAL AND S.HISAL;
  V_ENAME VARCHAR2(10);
  V_SAL   NUMBER(7,2);
  V_GRADE NUMBER;
BEGIN
  OPEN I;
  LOOP
    FETCH I INTO V_ENAME,V_SAL,V_GRADE;
    EXIT WHEN I%NOTFOUND;
    DBMS_OUTPUT.PUT(V_ENAME||'加薪前的工资为'||V_SAL||'，加薪后的工资为');
    UPDATE EMP
      SET SAL = CASE WHEN V_GRADE = 1 THEN SAL * 1.05
                     WHEN V_GRADE = 2 THEN SAL * 1.04
                     WHEN V_GRADE = 3 THEN SAL * 1.02
                     WHEN V_GRADE = 4 THEN SAL * 1.02
                     WHEN V_GRADE = 5 THEN  SAL * 1.01
                 END
      WHERE ENAME = V_ENAME;
    COMMIT;
    SELECT SAL INTO V_SAL FROM EMP WHERE ENAME = V_ENAME;
    DBMS_OUTPUT.PUT(V_SAL);
    DBMS_OUTPUT.NEW_LINE;
  END LOOP;
  CLOSE I;
END;

CALL SP_REBUILD_EMP();
SELECT * FROM EMP;
```

　　游标一旦打开 (OPEN)，到它关闭 (CLOSE) 前，游标面问的结果集是固定不变的，打开后修改数据源中的数据，对游标结果不会造成影响。



#### 10.根据传入参数打印公司信息，若输入结果为1，打印部门信息，若输入结果为2，打印员工信息

```SQL
DECLARE
  TYPE REF_A IS REF CURSOR;
  A      REF_A;
  V_NAME VARCHAR2(20);
  V_SQL  VARCHAR2(2000) := '&输入1或者2';
BEGIN
  IF V_SQL = 1 THEN
    OPEN A FOR
      SELECT DNAME FROM DEPT;
  ELSIF V_SQL = 2 THEN
    OPEN A FOR
      SELECT ENAME FROM EMP;
  END IF;
  LOOP
    FETCH A INTO V_NAME;
    EXIT WHEN A%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(V_NAME);
  END LOOP;
  CLOSE A;
END;
```



#### 11.打印员工信息，打印时可录入条件来限制打印内容，也可不录入(即传入内容为一个条件)

`eg:给定条件DEPETNO = 10，则仅打印10号部门的员工`
　　`--动态游标`

```SQL
DECLARE
  TYPE REF_A IS REF CURSOR;
  A       REF_A;
  AA      EMP%ROWTYPE;
  V_SQL   VARCHAR2(2000);
  V_WHERE VARCHAR2(2000) := '&请输入指定的条件';
BEGIN
  IF V_WHERE IS NULL THEN
    V_SQL := 'SELECT * FROM EMP';
    DBMS_OUTPUT.PUT_LINE('这是测试一下收到的是哪条语句'||V_SQL);
  ELSE
    V_SQL := 'SELECT * FROM EMP WHERE '||V_WHERE;
    DBMS_OUTPUT.PUT_LINE('这是测试一下收到的是哪条语句'||V_SQL);
  END IF;
  OPEN A FOR V_SQL;
  LOOP
    FETCH A INTO AA;
    EXIT WHEN A%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(AA.EMPNO||' '||AA.ENAME||' '||AA.JOB||' '||AA.MGR||' '||TO_CHAR(AA.HIREDATE,'YYYY/MM/DD')||' '||AA.SAL||' '||AA.COMM||' '||AA.DEPTNO);
  END LOOP;
  CLOSE A;
END;
```







