### PL/SQL基础练习题

#### 1. 创建一张DEPT_INFO表

> (DEPTNO NUMBER(2), DNAME VARCHAR2(14) , EMP_COUNT NUMBER, SAL_SUM NUMBER, SAL_AVG NUMBER);

创建一个`PL/SQL`程序，包含以下步骤:

- 1)清空`DEPT_INFO`表 并打印:目标表清理完成
- 2)统计各部门编号、名称、各部门总人数、各部门薪资总计、各部门平均薪资到`DEPT_INFO`表
- 并在提交后打印：数据加载完毕


```SQL
SELECT * FROM DEPT;
CREATE TABLE DEPT_INFO (DEPTNO NUMBER(2),DNAME VARCHAR2(14),EMP_COUNT NUMBER,SAL_SUM NUMBER,SAL_AVG NUMBER);

SELECT * FROM DEPT_INFO;
DROP TABLE DEPT_INFO;

SELECT D.DEPTNO,D.DNAME,COUNT(D.DEPTNO),SUM(E.SAL),TRUNC(AVG(E.SAL)) FROM DEPT D LEFT JOIN EMP E ON D.DEPTNO=E.DEPTNO GROUP BY D.DEPTNO,D.LOC,D.DNAME;

SELECT COUNT(D.DEPTNO),SUM(E.SAL) FROM DEPT D LEFT JOIN EMP E ON D.DEPTNO=E.DEPTNO GROUP BY D.DEPTNO;
```

```SQL
DECLARE 
BEGIN 
  EXECUTE IMMEDIATE 'CREATE TABLE DEPT_INFO (DEPTNO NUMBER(2),DNAME VARCHAR2(14),EMP_COUNT NUMBER, SAL_SUM NUMBER,SAL_AVG NUMBER)';
  DBMS_OUTPUT.PUT_LINE('DEPT_INFO表已创建');
  EXECUTE IMMEDIATE 'TRUNCATE TABLE DEPT_INFO';
  DBMS_OUTPUT.PUT_LINE('目标表清理完成');
  EXECUTE IMMEDIATE 'INSERT INTO DEPT_INFO SELECT D.DEPTNO,D.DNAME,COUNT(D.DEPTNO),SUM(E.SAL),TRUNC(AVG(E.SAL)) FROM DEPT D LEFT JOIN EMP E ON D.DEPTNO=E.DEPTNO GROUP BY D.DEPTNO,D.LOC,D.DNAME';
  DBMS_OUTPUT.PUT_LINE('数据加载完毕');
  COMMIT;
/*EXECUTE IMMEDIATE 'DROP TABLE DEPT_INFO';
  DBMS_OUTPUT.PUT_LINE('DEPT_INFO表已删除');*/
END;
```

```SQL
DECLARE
  V_CREATE   VARCHAR2(1000):= 'CREATE TABLE DEPT_INFO (DEPTNO NUMBER(2),DNAME VARCHAR2(14),EMP_COUNT NUMBER,SAL_SUM NUMBER,SAL_AVG NUMBER)';
  V_TRUNCATE VARCHAR2(1000):= 'TRUNCATE TABLE DEPT_INFO';
  V_INSERT   VARCHAR2(1000):= 'INSERT INTO DEPT_INFO SELECT D.DEPTNO,D.DNAME,COUNT(D.DEPTNO),SUM(E.SAL),TRUNC(AVG(E.SAL)) FROM DEPT D LEFT JOIN EMP E ON D.DEPTNO=E.DEPTNO GROUP BY D.DEPTNO,D.LOC,D.DNAME';
  V_DROP     VARCHAR2(1000):= 'DROP TABLE DEPT_INFO';
BEGIN
  EXECUTE IMMEDIATE V_CREATE;
  DBMS_OUTPUT.PUT_LINE('DEPT_INFO表已创建');
  EXECUTE IMMEDIATE V_TRUNCATE;
  DBMS_OUTPUT.PUT_LINE('目标表清理完成');
  EXECUTE IMMEDIATE V_INSERT;
  DBMS_OUTPUT.PUT_LINE('数据加载完毕');
  COMMIT;
/*EXECUTE IMMEDIATE V_DROP;
  DBMS_OUTPUT.PUT_LINE('DEPT_INFO表已删除');*/
END;
```



#### 2. 写一段PL/SQL程序

　　使用`EXECUTE命令`执行以下`DML`语句

```SQL
INSERT INTO EMP(EMPNO,ENAME,SAL) VALUES (1234,'ZHANGSAN',800) ;
```

　　并提交

```SQL
DECLARE
BEGIN
  EXECUTE IMMEDIATE 'INSERT INTO EMP(EMPNO,ENAME,SAL) VALUES(1234,''ZHANGSAN'',800)';
  COMMIT;
END;
```

```SQL
DECLARE
  V_SQL VARCHAR2(1000);
BEGIN
  V_SQL :=　'INSERT INTO EMP(EMPNO,ENAME,SAL) VALUES(1234,''ZHANGSAN'',800)'
  EXECUTE IMMEDIATE V_SQL;
  COMMIT;
END;
```



#### 3. 写一段PL/SQL程序

从键盘获取`MAX`/`MIN`/`AVG`/`SUM`中的一种

返回所有员工对应的`最大薪资`/`最小薪资`/`平均薪资`/`合计薪资`

统计结果按四舍五入处理到整数位

eg: 输入: `MAX`，返回:所有员工的最大薪资是5000元

​      输入: `AVG`，返回:所有员工的平均薪资是2073元

```SQL
DECLARE
  V_TYPE VARCHAR2(3) := UPPER('&请指定计算类型');
  V_SAL  NUMBER;
  V_SQL  VARCHAR2(1000);
BEGIN
  V_SQL := 'SELECT '||V_TYPE||'(SAL) FROM EMP';
  EXECUTE IMMEDIATE V_SQL INTO V_SAL;
  DBMS_OUTPUT.PUT_LINE('所有员工的'||CASE WHEN V_TYPE = 'MAX' THEN '最大' 
                                          WHEN V_TYPE = 'MIN' THEN '最小' 
                                          WHEN V_TYPE = 'SUM' THEN '合计' 
                                          WHEN V_TYPE = 'AVG' THEN '平均'
                                     END
                       ||'薪资是'||ROUND(V_SAL)||'元');
END;
```

### 注意：
　　无论是怎样的赋值方法，变量是单列变量还是多列变量，每次赋值都只能给变量赋予一行数据！

　　如果一次性将多行数据赋予给变量将会导致程序报错！

```SQL
DECLARE
  A NUMBER;
BEGIN
/*SELECT SAL INTO A FROM EMP WHERE ENAME = 'SMITH';  --一行刚好*/
/*SELECT SAL INTO A FROM EMP WHERE DEPTNO = 10;      --多行*/
  SELECT SAL INTO A FROM EMP WHERE ENAME = 'PEIQI';  --少了，没有对应人名
  DBMS_ OUTPUT.PUT_ LINE(A);
END;
```

